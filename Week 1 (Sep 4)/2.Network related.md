## Networking

### Caching
```c
//before
val client = OkHttpClient() // no cache configured

//after
val cacheSize = 5L * 1024 * 1024 // 5 MB
val cache = Cache(context.cacheDir, cacheSize)

val client = OkHttpClient.Builder()
    .cache(cache)
    .build()

```
### Batching Req
```c
for (id in 1..50) {
    api.getUser(id) // 50 separate calls
}
//afeter
api.getUsers(listOf(1,2,3,...50)) // single batch call
//1 request instead of 50.
```

### Req canceling
```c
fun search(query: String) {
    api.search(query).enqueue(callback)
}
//after
var call: Call? = null

fun search(query: String) {
    call?.cancel() // cancel previous
    call = api.search(query)
    call?.enqueue(callback)
}
// when we type something in a search bar , many req are genrated, so we will try to cancel the previous req, to decrese the load and saves bandwidth
```

### Json - parsing
```c
//json data form server
{
  "id": "123",
  "name": "Alice"
}
// now generally , if we use the belpw Gson then it will chck this at runtime, and verifies the json object and converts to User class object
val user = Gson().fromJson(jsonString, User::class.java)

//after
// // Moshi or Kotlinx Serialization (faster)
// it checks at compile time and generates parsing code fo rthr json object
data class User(val id: String, val name: String)

val user = Json.decodeFromString<User>(jsonString)

```

### Frequent calls in backgroundc

```c
//befpre
//wakes up every minute, condifer 10 apps doing it , waste of battery and cpu
Timer().scheduleAtFixedRate(0, 60000) {
    api.syncData()
}

//afeter
// if amny apps want to wake up at the same time, it wakes cpu at once and gives ot t otall of them, os hadles waking up the process
// when screnn is off ror idle, phone enters to a doze mode where network and cpu are paused, but gives maintainece windows every few hours
class SyncWorker(appContext: Context, params: WorkerParameters) :
    CoroutineWorker(appContext, params) {
    override suspend fun doWork(): Result {
        api.syncData()
        return Result.success()
    }
}

WorkManager.getInstance(context).enqueue(
    PeriodicWorkRequestBuilder<SyncWorker>(6, TimeUnit.HOURS).build()
)

```
### downloading full images
```c
Glide.with(context)
    .load(user.profilePicUrl) // loads original 2000x2000 image
    .into(imageView)

//after
Glide.with(context)
    .load(user.profilePicUrl)
    .override(200, 200) // load thumbnail size
    .into(imageView)

```

## Reuse Connections
```c
// BAD: new client = new connection for each request
// for every req if we create a new call, we establish new connectino, every time, which leads to high, latency and cpu usage

repeat(10) {
    val client = OkHttpClient()
    client.newCall(request).execute()
}

// instead make connection pool
val client = OkHttpClient()  // create once, reuse
repeat(10) {
    client.newCall(request).execute() // pooled
}
```

## Optimize Retry Strategy
```c
// Retry immediately on failure, if the server is down , then it is unnessasry to send req continusly and. burden the server and cpu
client.newCall(request).execute()

// after
fun retryWithBackoff(retries: Int = 3) {
    var delay = 1000L
    repeat(retries) {
        try {
            client.newCall(request).execute()
            return
        } catch (e: IOException) {
            Thread.sleep(delay)
            delay *= 2 // exponential backoff , here we will give the server time to recover
        }
    }
}

```

## Always Fetching Full File
```c
// Always fetches config.json (200KB) every launch
val request = Request.Builder()
    .url("https://api.example.com/config")
    .build()

// after
// use etags, when we req a file from teh server, the server will send a tag indiactig the file change (ETag: "abc123")
val request = Request.Builder()
    .url("https://api.example.com/config")
    .header("If-None-Match", savedEtag)   // send ETag from last time
    .build()

```


## optmised module loading (lazy load)
- remove unessary modules at startup
- load module on demand

```c
dependencies {
    implementation 'com.google.android.gms:play-services-maps:18.0.2'
    implementation 'com.facebook.android:facebook-android-sdk:12.0.1'
    implementation 'com.squareup.retrofit2:retrofit:2.9.0'
    implementation 'com.airbnb.android:lottie:5.0.3'
    implementation 'com.some.heavy:video-sdk:3.0.0' // not even used
}

```